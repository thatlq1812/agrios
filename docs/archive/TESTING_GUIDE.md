# Testing Guide

This document provides comprehensive testing procedures for all microservices in the Agrios project.

**Last Updated:** December 4, 2025  
**Version:** 1.0.0

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Setup](#setup)
- [User Service Tests](#user-service-tests)
- [Article Service Tests](#article-service-tests)
- [Integration Tests](#integration-tests)
- [Troubleshooting](#troubleshooting)
- [Related Documentation](#related-documentation)

---

## Overview

This testing guide covers:
- **User Service** (port 50051): Authentication, user management, JWT token handling
- **Article Service** (port 50052): Article CRUD operations with user integration
- **Integration Tests**: Cross-service communication and data consistency

All services use gRPC protocol and can be tested using `grpcurl` tool.

---

## Prerequisites

### Required Tools

- Docker Desktop
- grpcurl (for gRPC testing)
- curl (for REST API testing, if applicable)

### Installation

```bash
# Install grpcurl
# Windows (using Chocolatey)
choco install grpcurl

# macOS
brew install grpcurl

# Linux
go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest
```

### Environment Setup

Ensure all services are running:

```bash
cd /d/agrios
docker-compose up -d
```

Check service status:

```bash
docker ps
```

Expected containers:
- `agrios-postgres` (port 5432)
- `agrios-redis` (port 6379)
- `agrios-user-service` (port 50051)
- `agrios-article-service` (port 50052)
- `agrios-pgadmin` (port 5050)

---

## Setup

### 1. Start All Services

```bash
cd /d/agrios
docker-compose up -d --build
```

### 2. Verify Services Health

```bash
# Check container status
docker ps

# Check user service logs
docker logs agrios-user-service --tail 20

# Check article service logs
docker logs agrios-article-service --tail 20
```

### 3. Store Test Variables

For bash/zsh:
```bash
export USER_SERVICE="localhost:50051"
export ARTICLE_SERVICE="localhost:50052"
export TOKEN=""  # Will be set after login
```

For PowerShell:
```powershell
$USER_SERVICE = "localhost:50051"
$ARTICLE_SERVICE = "localhost:50052"
$TOKEN = ""  # Will be set after login
```

---

## User Service Tests

Service Endpoint: `localhost:50051`  
Proto Package: `user.UserService`

### Test 1: Create User

**Purpose:** Create a new user account

**Request:**
```bash
grpcurl -plaintext -d '{
  "name": "John Doe",
  "email": "john@example.com",
  "password": "Test123456"
}' localhost:50051 user.UserService/CreateUser
```

**Expected Response:**
```json
{
  "code": "000",
  "message": "success",
  "user": {
    "id": 1,
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2025-12-03T15:43:25Z"
  }
}
```

**Notes:**
- User ID is auto-generated by database
- Password is hashed using bcrypt before storage
- Email must be unique across the system
- Name and email are required fields

---

### Test 2: Login

**Purpose:** Authenticate user and receive JWT tokens

**Request:**
```bash
grpcurl -plaintext -d '{
  "email": "john@example.com",
  "password": "Test123456"
}' localhost:50051 user.UserService/Login
```

**Expected Response:**
```json
{
  "code": "000",
  "message": "success",
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2025-12-03T15:43:25Z"
  }
}
```

**Post-Test Action:**
```bash
# Save the access token for subsequent tests
export TOKEN="<accessToken_from_response>"
```


**Notes:**
- Save access token to environment variable
- Token expires after 24 hours (default)

---

### Test 3: Validate Token

**Purpose:** Verify JWT token is valid and not blacklisted

**Request:**
```bash
grpcurl -plaintext -d "{
  \"token\": \"$TOKEN\"
}" localhost:50051 user.UserService/ValidateToken
```

**Expected Response:**
```json
{
  "code": "000",
  "message": "success",
  "valid": true,
  "userId": "1",
  "email": "john@example.com"
}
```

**Notes:**
- Returns true if token is valid and not blacklisted
- Checks token signature and expiration
- Queries Redis for blacklist status
- Returns user ID and email from token claims

---

### Test 4: Get User by ID

**Purpose:** Retrieve user information by user ID

**Request:**
```bash
grpcurl -plaintext -d '{
  "id": 1
}' localhost:50051 user.UserService/GetUser
```

**Expected Response:**
```json
{
  "code": "000",
  "message": "success",
  "user": {
    "id": 1,
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2025-12-03T15:43:25Z"
  }
}
```

**Notes:**
- Returns user data without password hash
- Returns 404 if user ID does not exist
- User ID must be a valid integer

---

### Test 5: List Users

**Purpose:** Retrieve all users with pagination

**Request:**
```bash
grpcurl -plaintext -d '{}' localhost:50051 user.UserService/ListUsers
```

**Expected Response:**
```json
{
  "code": "000",
  "message": "success",
  "users": [
    {
      "id": 1,
      "name": "John Doe",
      "email": "john@example.com",
      "createdAt": "2025-12-03T15:43:25Z"
    }
  ],
  "total": "1",
  "size": 10
}
```


**Notes:**
- Default page size: 10
- Returns all users if no pagination params provided

---

### Test 6: Update User

**Purpose:** Update user information

**Request:**
```bash
grpcurl -plaintext -d '{
  "id": 1,
  "name": "John Updated",
  "email": "john.updated@example.com"
}' localhost:50051 user.UserService/UpdateUser
```

**Expected Response:**
```json
{
  "code": "000",
  "message": "success",
  "user": {
    "id": 1,
    "name": "John Updated",
    "email": "john.updated@example.com",
    "createdAt": "2025-12-03T15:43:25Z",
    "updatedAt": "2025-12-03T16:00:00Z"
  }
}
```

**Notes:**
- Both name and email are optional in update
- Email must be unique if provided
- Only provided fields are updated
- updatedAt timestamp is automatically set

---

### Test 7: Delete User

**Purpose:** Delete a user account

**Request:**
```bash
grpcurl -plaintext -d '{
  "id": 1
}' localhost:50051 user.UserService/DeleteUser
```

**Expected Response:**
```json
{
  "code": "000",
  "message": "success",
  "success": true
}
```

**Notes:**
- Performs hard delete from database
- Associated articles may be affected (check foreign key constraints)
- Cannot be undone

---

### Test 8: Logout

**Purpose:** Blacklist JWT token in Redis

**Request:**
```bash
grpcurl -plaintext -d "{
  \"token\": \"$TOKEN\"
}" localhost:50051 user.UserService/Logout
```

**Expected Response:**
```json
{
  "code": "000",
  "message": "success",
  "success": true
}
```


**Notes:**
- Token is added to Redis blacklist
- Subsequent ValidateToken calls should fail

---

### Test 9: Validate Blacklisted Token

**Purpose:** Verify that blacklisted token is rejected

**Request:**
```bash
grpcurl -plaintext -d "{
  \"token\": \"$TOKEN\"
}" localhost:50051 user.UserService/ValidateToken
```

**Expected Response:**
```json
{
  "code": "401",
  "message": "invalid or expired token",
  "valid": false
}
```


**Notes:**
- Must run after Test 8 (Logout)

---

### Test 10: Login with Wrong Password

**Purpose:** Test authentication failure handling

**Request:**
```bash
grpcurl -plaintext -d '{
  "email": "john@example.com",
  "password": "WrongPassword123"
}' localhost:50051 user.UserService/Login
```

**Expected Response:**
```json
{
  "code": "401",
  "message": "invalid credentials"
}
```

**Notes:**
- Returns 401 error code for invalid credentials
- Password verification uses bcrypt compare
- Email is case-insensitive

---

### Test 11: Create Duplicate User

**Purpose:** Test duplicate email validation

**Request:**
```bash
grpcurl -plaintext -d '{
  "name": "Jane Doe",
  "email": "john@example.com",
  "password": "Test123456"
}' localhost:50051 user.UserService/CreateUser
```

**Expected Response:**
```json
{
  "code": "409",
  "message": "email already exists"
}
```

**Notes:**
- Returns 409 Conflict status code
- Email uniqueness is enforced at database level
- Check is case-insensitive

---

## Article Service Tests

Service Endpoint: `localhost:50052`  
Proto Package: `article.ArticleService`

**Note:** All Article Service endpoints require authentication. Include the JWT token in the metadata.

### Test 12: Create Article

**Purpose:** Create a new article (authenticated)

**Request:**
```bash
grpcurl -plaintext \
  -H "authorization: Bearer $TOKEN" \
  -d '{
    "title": "My First Article",
    "content": "This is the content of my first article",
    "user_id": 1
  }' localhost:50052 article.ArticleService/CreateArticle
```

**Expected Response:**
```json
{
  "id": 1,
  "title": "My First Article",
  "content": "This is the content of my first article",
  "userId": 1,
  "createdAt": "2025-12-03T15:46:07Z",
  "updatedAt": "2025-12-03T15:46:07Z"
}
```


**Notes:**
- Requires valid JWT token
- User must exist in database

---

### Test 13: Get Article

**Purpose:** Retrieve article with user information

**Request:**
```bash
grpcurl -plaintext \
  -H "authorization: Bearer $TOKEN" \
  -d '{
    "id": 1
  }' localhost:50052 article.ArticleService/GetArticle
```

**Expected Response:**
```json
{
  "article": {
    "id": 1,
    "title": "My First Article",
    "content": "This is the content of my first article",
    "userId": 1,
    "createdAt": "2025-12-03T15:46:07Z",
    "updatedAt": "2025-12-03T15:46:07Z"
  },
  "user": {
    "id": 1,
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2025-12-03T15:43:25Z"
  }
}
```


**Notes:**
- Returns article with populated user information
- Makes inter-service call to User Service

---

### Test 14: List Articles

**Purpose:** Retrieve all articles with user information

**Request:**
```bash
grpcurl -plaintext \
  -H "authorization: Bearer $TOKEN" \
  -d '{}' localhost:50052 article.ArticleService/ListArticles
```

**Expected Response:**
```json
{
  "articles": [
    {
      "article": {
        "id": 1,
        "title": "My First Article",
        "content": "This is the content of my first article",
        "userId": 1,
        "createdAt": "2025-12-03T15:46:07Z",
        "updatedAt": "2025-12-03T15:46:07Z"
      },
      "user": {
        "id": 1,
        "name": "John Doe",
        "email": "john@example.com",
        "createdAt": "2025-12-03T15:43:25Z"
      }
    }
  ],
  "total": 1,
  "totalPages": 1
}
```


**Notes:**
- 

---

### Test 15: Update Article

**Purpose:** Update article content

**Request:**
```bash
grpcurl -plaintext \
  -H "authorization: Bearer $TOKEN" \
  -d '{
    "id": 1,
    "title": "My Updated Article",
    "content": "This is the updated content"
  }' localhost:50052 article.ArticleService/UpdateArticle
```

**Expected Response:**
```json
{
  "id": 1,
  "title": "My Updated Article",
  "content": "This is the updated content",
  "userId": 1,
  "createdAt": "2025-12-03T15:46:07Z",
  "updatedAt": "2025-12-03T16:10:00Z"
}
```

**Notes:**
- Both title and content are optional
- Only provided fields are updated
- Cannot change user_id (article ownership)
- updatedAt timestamp is automatically set

---

### Test 16: Delete Article

**Purpose:** Delete an article

**Request:**
```bash
grpcurl -plaintext \
  -H "authorization: Bearer $TOKEN" \
  -d '{
    "id": 1
  }' localhost:50052 article.ArticleService/DeleteArticle
```

**Expected Response:**
```json
{
  "success": true
}
```

**Notes:**
- Performs hard delete from database
- Cannot be undone
- Returns success=true on successful deletion

---

### Test 17: Create Article Without Token

**Purpose:** Test authentication requirement

**Request:**
```bash
grpcurl -plaintext \
  -d '{
    "title": "Unauthorized Article",
    "content": "This should fail",
    "user_id": 1
  }' localhost:50052 article.ArticleService/CreateArticle
```

**Expected Response:**
```
ERROR:
  Code: Unauthenticated
  Message: authentication required
```


**Notes:**
- Should fail without authorization header

---

### Test 18: Create Article with Invalid Token

**Purpose:** Test invalid token handling

**Request:**
```bash
grpcurl -plaintext \
  -H "authorization: Bearer invalid.token.here" \
  -d '{
    "title": "Invalid Token Article",
    "content": "This should fail",
    "user_id": 1
  }' localhost:50052 article.ArticleService/CreateArticle
```

**Expected Response:**
```
ERROR:
  Code: Unauthenticated
  Message: invalid token
```

**Notes:**
- Returns gRPC Unauthenticated error
- All Article Service methods require authentication
- Token must be in authorization metadata header

---

## Integration Tests

### Test 19: Cross-Service User Verification

**Purpose:** Verify Article Service correctly validates users via User Service

**Steps:**
1. Create a new user in User Service
2. Login and get token
3. Create an article with that user_id
4. Verify article contains correct user information


**Notes:**
- Tests inter-service communication

---

### Test 20: Token Blacklist Propagation

**Purpose:** Verify blacklisted token is rejected by Article Service

**Steps:**
1. Login and get token
2. Create an article successfully
3. Logout (blacklist token)
4. Try to create another article with blacklisted token
5. Should receive authentication error


**Notes:**
- Tests Redis blacklist functionality across services

---

## Troubleshooting

### Services Not Starting

```bash
# Check logs
docker logs agrios-user-service
docker logs agrios-article-service
docker logs agrios-postgres
docker logs agrios-redis

# Restart services
docker-compose down
docker-compose up -d --build
```

### Connection Refused

```bash
# Check if services are healthy
docker ps

# Check network
docker network inspect agrios_agrios-network
```

### Database Issues

```bash
# Connect to PostgreSQL
docker exec -it agrios-postgres psql -U postgres

# Check databases
\l

# Check user service tables
\c agrios_users
\dt

# Check article service tables
\c agrios_articles
\dt
```

### Redis Issues

```bash
# Connect to Redis
docker exec -it agrios-redis redis-cli

# Check keys
KEYS *

# Check blacklisted tokens
KEYS blacklist:*
```

---

## Notes

### Response Codes

Standard response codes used across all services:
- `000`: Success
- `400`: Bad Request / Validation Error
- `401`: Unauthorized / Invalid Credentials
- `404`: Not Found
- `409`: Conflict (e.g., duplicate email)
- `500`: Internal Server Error

### Token Configuration

- **Access Token Expiry:** 24 hours (default)
- **Refresh Token Expiry:** 7 days (default)
- **Token Storage:** Redis blacklist for logout functionality
- **Token Format:** JWT with HS256 signing

### Pagination

- **Default Page Size:** 10 items
- **Max Page Size:** 100 items (configurable)

### Timestamps

- All timestamps are in UTC format
- Format: ISO 8601 (e.g., `2025-12-03T15:43:25Z`)

---

## Related Documentation

For more detailed information, refer to:

- **[API Reference](./API_REFERENCE.md)** - Complete API documentation with examples
- **[Operations Guide](./OPERATIONS_GUIDE.md)** - Deployment and operations procedures
- **[JWT Blacklist Tutorial](./tutorials/JWT_BLACKLIST_REDIS.md)** - Implementation details for token blacklisting
- **[Workflow Guide](./tutorials/WORKFLOW_GUIDE.md)** - Development workflow and Git practices
- **[Response Format Migration](./RESPONSE_FORMAT_MIGRATION.md)** - API response format standards

---

## Change Log

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-12-04 | 1.0.0 | Initial testing guide created with comprehensive test cases | GitHub Copilot |

